<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Details - Flow</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <style>
        :root {
            --primary-dark-charcoal: #131A23;
            --primary-bright-yellow: #F6EF31;
            --text-on-dark: #FFFFFF;
            --text-on-dark-subtle: #cccccc;
            --text-dark: #333333;
            --text-medium: #555555;
            --text-light: #777777;
            --background-light: #FFFFFF;
            --background-page: #f8f9fa;
            --border-light: #e9ecef;
            --accent-greenish-yellow: #95cb00;
            --accent-greenish-yellow-darker: #7da800;
            --success-green: #28a745;
            --success-green-darker: #1e7e34;
            --light-yellow-bg: #fffef7;
            --accent-blue-link: #007bff;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--background-page);
        }

        .container {
            width: 90%;
            max-width: 1100px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Header Styles */
        .container-header {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        header.page-top-header {
            background: var(--primary-dark-charcoal);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1001;
            transition: background 0.3s;
            padding: 0;
            height: 60px;
        }

        header.page-top-header h1.logo {
            color: var(--text-on-dark);
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
        }

        header.page-top-header nav ul {
            padding: 0;
            margin: 0;
            list-style: none;
            display: flex;
            align-items: center;
            height: 60px;
        }

        header.page-top-header nav ul li {
            margin-left: 25px;
            height: 60px;
            display: flex;
            align-items: center;
        }

        header.page-top-header nav ul li a {
            text-decoration: none;
            color: var(--text-on-dark-subtle);
            font-weight: 500;
            transition: color 0.3s ease;
            font-size: 0.9em;
        }

        header.page-top-header nav ul li a:hover,
        header.page-top-header nav ul li a.active {
            color: var(--primary-bright-yellow);
        }

        /* Trip Detail Card Styles */
        .trip-detail-main-card {
            background-color: var(--background-light);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
            transition: box-shadow 0.3s ease;
        }

        .trip-detail-layout-top {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .trip-image-column {
            flex: 1 1 450px;
            min-width: 300px;
        }

        .trip-image-large-container {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
        }

        .trip-image-large-container img {
            width: 100%;
            display: block;
            aspect-ratio: 16/10;
            object-fit: cover;
        }

        .trip-image-tag {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: var(--accent-greenish-yellow);
            color: var(--text-on-dark);
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .trip-special-info {
            background-color: var(--light-yellow-bg);
            padding: 20px;
            border-radius: 8px;
        }

        .trip-special-info h3 {
            font-size: 1.3em;
            color: var(--text-dark);
            margin-top: 0;
            margin-bottom: 15px;
        }

        .trip-special-info p {
            font-size: 0.9em;
            color: var(--text-medium);
            margin-bottom: 8px;
        }

        .trip-special-info strong {
            font-weight: 600;
            color: var(--text-dark);
        }

        .btn-go-to-itinerary {
            display: inline-block;
            margin-top: 15px;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            text-decoration: none;
            cursor: pointer;
            padding: 10px 18px;
            background-color: var(--accent-greenish-yellow);
            border-radius: 5px;
            border: none;
            transition: background-color 0.3s ease;
        }

        .btn-go-to-itinerary:hover {
            background-color: var(--accent-greenish-yellow-darker);
        }

        .btn-go-to-itinerary i {
            margin-left: 5px;
            transition: transform 0.3s ease;
        }

        .btn-go-to-itinerary.expanded i {
            transform: rotate(180deg);
        }

        .trip-info-column {
            flex: 1 1 400px;
            min-width: 300px;
            padding: 20px;
        }

        .trip-info-column h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 15px;
            line-height: 1.2;
        }

        .trip-stats {
            display: flex;
            gap: 25px;
            margin-bottom: 15px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }

        .trip-stats span {
            color: var(--text-light);
            text-align: center;
        }

        .trip-stats span strong {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--text-dark);
            display: block;
            line-height: 1;
        }

        .trip-rating {
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .trip-rating .stars {
            color: #f39c12;
            margin-right: 8px;
            font-size: 1.1em;
        }

        .trip-rating a {
            color: var(--text-light);
            text-decoration: none;
            margin-left: 5px;
        }

        .trip-rating a:hover {
            text-decoration: underline;
        }

        .trip-pricing {
            margin-bottom: 25px;
        }

        .trip-pricing .price-from {
            font-size: 0.9em;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .trip-pricing .current-price {
            font-size: 2em;
            font-weight: 700;
            color: var(--success-green);
            margin-right: 8px;
        }

        .btn-book-now {
            display: inline-block;
            background-color: var(--success-green);
            color: var(--text-on-dark);
            padding: 15px 35px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 700;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            margin-bottom: 25px;
            border: none;
            cursor: pointer;
        }

        .btn-book-now:hover {
            background-color: var(--success-green-darker);
        }

        .btn-book-now i {
            margin-right: 8px;
        }

        .trip-quick-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 20px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: var(--text-medium);
        }

        .trip-quick-details span i {
            margin-right: 8px;
            color: var(--accent-greenish-yellow);
        }

        .trip-description {
            margin-bottom: 25px;
        }

        .trip-description h3 {
            font-size: 1.4em;
            color: var(--text-dark);
            margin-bottom: 12px;
        }

        .trip-description .description-content {
            line-height: 1.7;
            color: var(--text-medium);
        }

        /* Daily Itinerary Section */
        .detailed-itinerary-section {
            background-color: var(--background-light);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 30px;
        }

        .detailed-itinerary-section h2 {
            font-size: 1.8em;
            color: var(--text-dark);
            margin-bottom: 25px;
            text-align: center;
        }

        .daily-itinerary-container {
            position: relative;
        }

        .daily-itinerary-scroll {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 10px 0 20px 0;
            scroll-behavior: smooth;
        }

        .daily-itinerary-scroll::-webkit-scrollbar {
            height: 8px;
        }

        .daily-itinerary-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .daily-itinerary-scroll::-webkit-scrollbar-thumb {
            background: var(--accent-greenish-yellow);
            border-radius: 10px;
        }

        .day-card {
            min-width: 320px;
            max-width: 340px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            flex-shrink: 0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .day-card-image {
            position: relative;
            height: 200px;
            overflow: hidden;
        }

        .day-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .day-card:hover .day-card-image img {
            transform: scale(1.05);
        }

        .day-number-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .day-header {
            padding: 20px 20px 10px 20px;
        }

        .day-header h4 {
            font-size: 1.2em;
            color: var(--text-dark);
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        .day-title {
            font-size: 0.9em;
            color: var(--text-medium);
            margin: 0;
        }

        .day-content {
            padding: 0 20px 20px 20px;
        }

        .day-activities h5 {
            font-size: 1em;
            color: var(--text-dark);
            margin: 0 0 10px 0;
            font-weight: 600;
        }

        .day-activities h5 i {
            margin-right: 8px;
            color: var(--accent-greenish-yellow);
        }

        .day-activities p {
            font-size: 0.9em;
            color: var(--text-medium);
            line-height: 1.6;
            margin: 0;
        }

        /* AI Chat Section */
        #aiChatSection {
            background-color: var(--background-light);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 30px;
        }

        #aiChatSection .section-header {
            text-align: center;
            margin-bottom: 25px;
        }

        #aiChatSection h3 {
            font-size: 1.6em;
            color: var(--text-dark);
            margin: 0 0 10px 0;
        }

        #aiChatSection p {
            color: var(--text-medium);
            margin: 0;
        }

        .ai-chat-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .ai-message,
        .user-message {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .ai-message .message-avatar {
            background: var(--accent-greenish-yellow);
            color: white;
        }

        .user-message .message-avatar {
            background: var(--primary-dark-charcoal);
            color: white;
        }

        .message-content {
            flex: 1;
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .user-message .message-content {
            background: var(--primary-bright-yellow);
            color: var(--text-dark);
        }

        .message-content p {
            margin: 0;
            line-height: 1.5;
        }

        .chat-input-container {
            margin-top: 20px;
        }

        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .suggestion-chip {
            background: var(--border-light);
            color: var(--text-medium);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .suggestion-chip:hover {
            background: var(--accent-greenish-yellow);
            color: white;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        #chatInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-light);
            border-radius: 25px;
            font-size: 0.9em;
            outline: none;
        }

        #chatInput:focus {
            border-color: var(--accent-greenish-yellow);
        }

        #sendChatBtn {
            background: var(--accent-greenish-yellow);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #sendChatBtn:hover {
            background: var(--accent-greenish-yellow-darker);
        }

        #sendChatBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Loading and Error States */
        .loading-state {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: var(--text-medium);
        }

        .error-state {
            text-align: center;
            padding: 40px;
            background: #fff3f3;
            border-radius: 8px;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-medium);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Footer Styles */
        footer.page-bottom-footer {
            background: var(--primary-dark-charcoal);
            color: var(--text-on-dark-subtle);
            text-align: center;
            padding: 40px 0;
            margin-top: 50px;
        }

        footer.page-bottom-footer a {
            color: var(--primary-bright-yellow);
            text-decoration: none;
        }

        footer.page-bottom-footer a:hover {
            color: var(--text-on-dark);
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 0 15px;
            }

            .trip-detail-layout-top {
                flex-direction: column;
                gap: 20px;
            }

            .trip-image-column,
            .trip-info-column {
                flex: 1 1 100%;
                min-width: auto;
            }

            .trip-info-column h1 {
                font-size: 1.8em;
            }

            .trip-stats {
                gap: 15px;
            }

            .day-card {
                min-width: 280px;
            }

            .chat-suggestions {
                justify-content: center;
            }

            .suggestion-chip {
                font-size: 0.8em;
                padding: 6px 12px;
            }
        }
    </style>
</head>

<body>
    <header class="page-top-header">
        <div class="container-header">
            <h1 class="logo" style="cursor:pointer;" onclick="window.location.href='intro.html'">Flow</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#travel-destinations">Destinations</a></li>
                    <li><a href="index.html#popular-trips">Popular Trips</a></li>
                    <li><a href="index.html#contact-footer">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Loading State -->
        <div id="loadingMessage" class="loading-state" style="display:none;">
            <i class="fas fa-spinner fa-spin"></i> Loading trip details...
        </div>

        <!-- Main Trip Details Card -->
        <div id="tripDetailMainCard" class="trip-detail-main-card" style="display:none;" data-aos="fade-in">
            <!-- Content will be populated by JavaScript -->
        </div>

        <!-- Daily Itinerary Section -->
        <section class="detailed-itinerary-section" id="detailedItinerarySection" data-aos="fade-up"
            style="display:none;">
            <h2><i class="fas fa-calendar-alt"></i> Day-by-Day Itinerary</h2>
            <div class="daily-itinerary-container">
                <div class="daily-itinerary-scroll" id="dailyItineraryContainer">
                    <!-- Day cards will be inserted here -->
                </div>
            </div>
        </section>

        <!-- AI Chat Section -->
        <section id="aiChatSection" class="detail-section">
            <div class="section-header">
                <h3><i class="fas fa-robot"></i> Ask Our AI Travel Assistant</h3>
                <p>Get instant answers about your trip, local recommendations, and travel tips!</p>
            </div>

            <div class="ai-chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="ai-message">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <p>Hi! I'm your AI travel assistant. Ask me anything about your trip!</p>
                        </div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-suggestions">
                        <div class="suggestion-chip" data-question="What's the best time to visit?">
                            üå§Ô∏è Best time to visit?
                        </div>
                        <div class="suggestion-chip" data-question="What should I pack?">
                            üéí What to pack?
                        </div>
                        <div class="suggestion-chip" data-question="Any local food recommendations?">
                            üçú Local food tips?
                        </div>
                        <div class="suggestion-chip" data-question="How much should I budget for meals?">
                            üí∞ Meal budget?
                        </div>
                    </div>

                    <div class="chat-input-wrapper">
                        <input type="text" id="chatInput" placeholder="Ask about your trip...">
                        <button id="sendChatBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer id="contact-footer" class="page-bottom-footer container-fluid">
        <div class="container">
            <p>¬© <span id="year"></span> Flow - All Rights Reserved.</p>
            <p><a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a></p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script>
        AOS.init({
            duration: 700,
            once: true,
            offset: 50,
        });
    </script>

    <script>
        // Global variables
        let currentTripData = null;

        // DOM Elements
        const loadingDiv = document.getElementById('loadingMessage');
        const contentCard = document.getElementById('tripDetailMainCard');
        const detailedItinerarySection = document.getElementById('detailedItinerarySection');
        const dailyItineraryContainer = document.getElementById('dailyItineraryContainer');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            const yearSpan = document.querySelector('#year');
            if (yearSpan) yearSpan.textContent = new Date().getFullYear();

            loadInitialTripDetails();
            initializeAIChat();
        });

        // Load initial trip details - FIXED to always fetch fresh data
        function loadInitialTripDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const itineraryId = urlParams.get('id');
            const storedTripData = localStorage.getItem('selectedTripForDetailView');

            console.log('üîç Loading trip details for ID:', itineraryId);
            console.log('üìã Stored trip data exists:', !!storedTripData);

            if (loadingDiv) loadingDiv.style.display = 'block';

            // ALWAYS try to fetch fresh data first, even if we have cached data
            if (itineraryId) {
                console.log('üîÑ Fetching fresh trip data from API for ID:', itineraryId);
                fetchFreshTripData(itineraryId, storedTripData);
            } else if (storedTripData) {
                // Only use cached data if no ID is available
                try {
                    currentTripData = JSON.parse(storedTripData);
                    console.log('‚úÖ Using cached trip data as fallback');
                    populateTripDetails(currentTripData);
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    if (contentCard) contentCard.style.display = 'block';
                } catch (e) {
                    console.error('‚ùå Error parsing stored trip data:', e);
                    showNoTripFoundMessage(null);
                }
            } else {
                console.log('‚ùå No trip ID or stored data found');
                showNoTripFoundMessage(null);
            }
        }

        // New function to fetch fresh trip data
        function fetchFreshTripData(itineraryId, fallbackData) {
            // Clear old cached data first
            console.log('üóëÔ∏è Clearing old cached data');
            localStorage.removeItem('selectedTripForDetailView');

            // Try to fetch from itineraries API with force refresh
            fetch('/api/itineraries?refresh=true')
                .then(response => response.json())
                .then(data => {
                    console.log('üìã Fresh API response:', data);

                    if (data.itineraries && data.itineraries.length > 0) {
                        const foundTrip = data.itineraries.find(trip =>
                            (trip['id:'] && trip['id:'] === itineraryId) ||
                            (trip.id && trip.id === itineraryId)
                        );

                        if (foundTrip) {
                            console.log('‚úÖ Found fresh trip data from API');
                            currentTripData = foundTrip;

                            // Store fresh data in localStorage
                            localStorage.setItem('selectedTripForDetailView', JSON.stringify(foundTrip));

                            populateTripDetails(foundTrip);
                            if (loadingDiv) loadingDiv.style.display = 'none';
                            if (contentCard) contentCard.style.display = 'block';

                            // Load daily itinerary with force refresh
                            loadDailyItinerary(true);
                        } else {
                            console.log('‚ö†Ô∏è Trip not found in fresh API data, trying fallback');
                            useFallbackData(fallbackData, itineraryId);
                        }
                    } else {
                        console.log('‚ö†Ô∏è No itineraries in fresh API response, trying fallback');
                        useFallbackData(fallbackData, itineraryId);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Failed to fetch fresh data from API:', error);
                    useFallbackData(fallbackData, itineraryId);
                });
        }

        // Helper function to use fallback data
        function useFallbackData(storedTripData, itineraryId) {
            if (storedTripData) {
                try {
                    currentTripData = JSON.parse(storedTripData);
                    console.log('‚úÖ Using cached trip data as fallback');
                    populateTripDetails(currentTripData);
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    if (contentCard) contentCard.style.display = 'block';

                    // Still try to load fresh daily itinerary
                    loadDailyItinerary(true);
                } catch (e) {
                    console.error('‚ùå Error parsing stored trip data:', e);
                    showNoTripFoundMessage(itineraryId);
                }
            } else {
                console.log('‚ùå No fallback data available');
                showNoTripFoundMessage(itineraryId);
            }
        }

        // Show error message
        function showNoTripFoundMessage(id) {
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="error-state">
                        <h3>Trip Not Found</h3>
                        <p>We couldn't find trip details for ID: ${id}</p>
                        <button onclick="window.location.href='all_itineraries.html'" class="btn-book-now">
                            Browse All Trips
                        </button>
                    </div>
                `;
                loadingDiv.style.display = 'block';
            }
        }

        // Populate trip details - UPDATED to remove refresh button
        function populateTripDetails(trip) {
            if (!contentCard) return;

            console.log('üîç Trip data received:', trip);

            // Extract data with fallbacks
            let priceDisplay = "Price on request";
            const costField = trip['approx_cost_usd_pp:'] || trip.approx_cost_usd_pp || 0;
            const budgetField = trip['budget_level_csv:'] || trip.budget_level || '';
            const durationField = parseInt(trip['duration_days:'] || trip.duration_days || 0);

            // Calculate price
            if (costField && parseFloat(costField) > 0) {
                const totalCost = parseFloat(costField);
                if (durationField && durationField > 0) {
                    const perDayCost = Math.round(totalCost / durationField);
                    priceDisplay = `$${perDayCost} per day`;
                } else {
                    priceDisplay = `$${Math.round(totalCost)} total`;
                }
            } else if (budgetField && budgetField.trim()) {
                const budget = budgetField.toLowerCase().trim();
                if (budget.includes('budget') || budget.includes('low')) {
                    priceDisplay = "$50 - $100 per day";
                } else if (budget.includes('medium') || budget.includes('mid')) {
                    priceDisplay = "$100 - $200 per day";
                } else if (budget.includes('luxury') || budget.includes('high')) {
                    priceDisplay = "$200+ per day";
                }
            }

            // Extract other fields
            const tripTitle = trip['title:'] || trip.title || 'Amazing Trip';
            const tripImage = trip['image_url:'] || trip.image_url || 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=600&h=400&fit=crop&q=80';
            const tripCategory = trip['primary_interest_category:'] || trip.primary_interest || 'Adventure';
            const tripRegion = trip['region_definition:'] || trip.region || 'Amazing Destination';
            const tripArrivalCity = trip['arrival_city:'] || trip.arrival_city || 'TBD';
            const tripTravellerTypes = trip['traveller_type_tags_csv:'] || trip.traveller_type_tags || '';
            const tripDescription = trip['description_long:'] || trip.description || 'An amazing travel experience awaits you!';
            const tripId = trip['id:'] || trip.id;

            // Populate HTML
            contentCard.innerHTML = `
                <div class="trip-detail-layout-top">
                    <div class="trip-image-column">
                        <div class="trip-image-large-container">
                            <img src="${tripImage}" alt="${tripTitle}" loading="lazy">
                            <div class="trip-image-tag">${tripCategory}</div>
                        </div>
                        <div class="trip-special-info">
                            <h3><i class="fas fa-route"></i> Your Journey Awaits</h3>
                            <p><strong>Destination:</strong> ${tripRegion}</p>
                            <p><strong>Duration:</strong> ${durationField || 'Flexible'} days</p>
                            <p><strong>Arrival City:</strong> ${tripArrivalCity}</p>
                            ${tripTravellerTypes ? `<p><strong>Perfect for:</strong> ${tripTravellerTypes}</p>` : ''}
                            <button id="goToFullItineraryBtn" class="btn-go-to-itinerary">
                                VIEW FULL ITINERARY <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    <div class="trip-info-column">
                        <h1>${tripTitle}</h1>
                        <div class="trip-stats">
                            <span><strong>${durationField || 'N/A'}</strong> Days</span>
                            <span><strong>${tripCategory}</strong> Focus</span>
                            <span><strong>${tripRegion}</strong> Region</span>
                        </div>
                        <div class="trip-rating">
                            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span> 4.8 (127 reviews) 
                            <a href="#reviews">See all reviews</a>
                        </div>
                        <div class="trip-pricing">
                            <div class="price-from">From</div>
                            <span class="current-price">${priceDisplay}</span>
                        </div>
                        <button class="btn-book-now" onclick="window.location.href='payment.html?id=${tripId}&title=${encodeURIComponent(tripTitle)}&price=${encodeURIComponent(priceDisplay)}'">
                            <i class="fas fa-credit-card"></i> Book Now
                        </button>
                        <div class="trip-quick-details">
                            <span><i class="fas fa-plane-departure"></i> Starts in ${tripArrivalCity}</span>
                            <span><i class="fas fa-users"></i> Perfect for ${tripTravellerTypes || 'all travelers'}</span>
                            <span><i class="fas fa-star"></i> ${tripCategory} focused</span>
                        </div>
                        <div class="trip-description">
                            <h3>About This Trip</h3>
                            <div class="description-content">
                                ${tripDescription}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            setupItineraryButton();
        }

        // Update the setupItineraryButton function - SIMPLIFIED (no refresh button)
        function setupItineraryButton() {
            const goToItineraryBtn = document.getElementById('goToFullItineraryBtn');

            if (goToItineraryBtn && detailedItinerarySection) {
                goToItineraryBtn.addEventListener('click', function () {
                    const isExpanded = detailedItinerarySection.style.display === 'block';

                    if (isExpanded) {
                        detailedItinerarySection.style.display = 'none';
                        this.innerHTML = 'VIEW FULL ITINERARY <i class="fas fa-chevron-down"></i>';
                        this.classList.remove('expanded');
                    } else {
                        detailedItinerarySection.style.display = 'block';
                        this.innerHTML = 'HIDE FULL ITINERARY <i class="fas fa-chevron-up"></i>';
                        this.classList.add('expanded');

                        // Load with force refresh to get latest data
                        loadDailyItinerary(true);

                        // Scroll to the section
                        detailedItinerarySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }
        }

        // Load daily itinerary with force refresh option
        async function loadDailyItinerary(forceRefresh = false) {
            if (!currentTripData) {
                console.error('‚ùå No currentTripData available');
                return;
            }

            const tripId = currentTripData['id:'] || currentTripData.id;
            console.log('üîÑ Loading daily itinerary for trip:', tripId, forceRefresh ? '(force refresh)' : '');

            if (!dailyItineraryContainer) {
                console.error('‚ùå Container not found');
                return;
            }

            dailyItineraryContainer.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading detailed itinerary...</div>';

            try {
                // Add refresh parameter to force fresh data
                const apiUrl = `/api/daily-plans?itinerary_id=${tripId}${forceRefresh ? '&refresh=true' : ''}`;
                console.log('üåê Fetching from:', apiUrl);

                const response = await fetch(apiUrl);

                if (response.ok) {
                    const data = await response.json();
                    console.log('üìã Daily plans API response:', data);

                    if (data.days && data.days.length > 0) {
                        console.log('‚úÖ Found', data.days.length, 'days of data');
                        displayDailyItineraryCards(data.days);
                    } else {
                        console.log('‚ö†Ô∏è No daily plans found, generating sample');
                        generateSampleItinerary();
                    }
                } else {
                    console.error('‚ùå API request failed:', response.status);
                    generateSampleItinerary();
                }
            } catch (error) {
                console.error('‚ùå Error fetching daily plans:', error);
                generateSampleItinerary();
            }
        }

        // Display daily itinerary cards - FIXED
        function displayDailyItineraryCards(days) {
            if (!dailyItineraryContainer) return;

            dailyItineraryContainer.innerHTML = '';

            // Sort days by day number
            const sortedDays = days.sort((a, b) =>
                parseInt(a.day_number || a['day_number:'] || 0) - parseInt(b.day_number || b['day_number:'] || 0)
            );

            console.log('üé® Displaying sorted days:', sortedDays);

            sortedDays.forEach((day, index) => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';

                // Fixed: Better field name handling
                const dayNum = day.day_number || day['day_number:'] || (index + 1);
                const dayTitle = day.day_title || day['day_title:'] || `Day ${dayNum} Activities`;
                const dayLocation = day.day_main_location || day['day_main_location:'] || '';

                // Get image URL with better fallback handling
                let dayImage = '';
                const imageFields = [
                    day['daywise Image_Url'],
                    day['daywise_image_url:'],
                    day.daywise_image_url,
                    day['image_url:'],
                    day.image_url
                ];

                for (const field of imageFields) {
                    if (field && field.trim() && field !== 'N/A') {
                        dayImage = field.trim();
                        break;
                    }
                }

                if (!dayImage) {
                    dayImage = getDestinationFallbackImage(dayLocation, dayNum);
                }

                // Build activities content with better handling
                let activitiesContent = '';

                // Check for activities array first
                if (day.activities && Array.isArray(day.activities) && day.activities.length > 0) {
                    activitiesContent = day.activities.map(activity =>
                        `<strong>${activity.activity_time_of_day || activity['activity_time_of_day:'] || 'Morning'}:</strong> ${activity.activity_description || activity['activity_description:'] || 'Activity planned'}`
                    ).join('<br>');
                } else {
                    // Check for individual activity fields
                    const activityFields = [
                        day['morning_activity:'] || day.morning_activity,
                        day['afternoon_activity:'] || day.afternoon_activity,
                        day['evening_activity:'] || day.evening_activity
                    ].filter(Boolean);

                    if (activityFields.length > 0) {
                        activitiesContent = activityFields.map((activity, i) => {
                            const timeLabels = ['Morning', 'Afternoon', 'Evening'];
                            return `<strong>${timeLabels[i]}:</strong> ${activity}`;
                        }).join('<br>');
                    } else {
                        // Fallback to any description field
                        activitiesContent = day.description || day['description:'] || day.day_description || day['day_description:'] || 'Activities will be customized based on your preferences.';
                    }
                }

                dayCard.innerHTML = `
                    <div class="day-card-image">
                        <img src="${dayImage}" 
                             alt="Day ${dayNum} - ${dayTitle}" 
                             loading="lazy"
                             onerror="this.src='${getDestinationFallbackImage(dayLocation, dayNum)}'">
                        <div class="day-number-badge">Day ${dayNum}</div>
                    </div>
                    <div class="day-header">
                        <h4>${dayTitle}</h4>
                        ${dayLocation ? `<p class="day-title">üìç ${dayLocation}</p>` : ''}
                    </div>
                    <div class="day-content">
                        <div class="day-activities">
                            <h5><i class="fas fa-map-marked-alt"></i> Activities</h5>
                            <p>${activitiesContent}</p>
                        </div>
                    </div>
                `;

                dailyItineraryContainer.appendChild(dayCard);
            });
        }

        // Generate sample itinerary - ENHANCED
        function generateSampleItinerary() {
            if (!dailyItineraryContainer || !currentTripData) return;

            const duration = parseInt(currentTripData['duration_days:'] || currentTripData.duration_days || 5);
            const destination = currentTripData['region_definition:'] || currentTripData.region || 'Your Destination';

            console.log('üé® Generating sample itinerary for', duration, 'days in', destination);

            dailyItineraryContainer.innerHTML = '';

            // Generate sample days based on duration
            for (let i = 1; i <= duration; i++) {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';

                const sampleActivities = [
                    'Arrival and check-in to accommodation',
                    'City exploration and local cuisine tasting',
                    'Cultural site visits and guided tours',
                    'Adventure activities and nature exploration',
                    'Shopping and leisure time',
                    'Departure and final preparations'
                ];

                const dayImage = getDestinationFallbackImage(destination, i);
                const activity = sampleActivities[Math.min(i - 1, sampleActivities.length - 1)];

                dayCard.innerHTML = `
                    <div class="day-card-image">
                        <img src="${dayImage}" 
                             alt="Day ${i} - ${destination}" 
                             loading="lazy">
                        <div class="day-number-badge">Day ${i}</div>
                    </div>
                    <div class="day-header">
                        <h4>Day ${i} - ${destination}</h4>
                        <p class="day-title">üìç ${destination}</p>
                    </div>
                    <div class="day-content">
                        <div class="day-activities">
                            <h5><i class="fas fa-map-marked-alt"></i> Planned Activities</h5>
                            <p><strong>Full Day:</strong> ${activity}</p>
                            <p><em>Detailed itinerary will be provided upon booking.</em></p>
                        </div>
                    </div>
                `;

                dailyItineraryContainer.appendChild(dayCard);
            }
        }

        // Get fallback image for destinations
        function getDestinationFallbackImage(location, dayNumber) {
            const fallbackImages = {
                'vietnam': [
                    'https://images.unsplash.com/photo-1583417319070-4a69db38a482?w=800&h=600&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1540179769-e4ca7b47b5e0?w=800&h=600&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1559592413-7cec4d0cae2b?w=800&h=600&fit=crop&q=80'
                ],
                'singapore': [
                    'https://images.unsplash.com/photo-1508062878650-88b52897f298?w=800&h=600&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1543732028-8cfc2f3daaab?w=800&h=600&fit=crop&q=80'
                ],
                'default': [
                    'https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=800&h=600&fit=crop&q=80',
                    'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&h=600&fit=crop&q=80'
                ]
            };

            const destination = (location || '').toLowerCase();
            let imageSet = fallbackImages.default;

            if (destination.includes('vietnam')) imageSet = fallbackImages.vietnam;
            else if (destination.includes('singapore')) imageSet = fallbackImages.singapore;

            const imageIndex = ((dayNumber || 1) - 1) % imageSet.length;
            return imageSet[imageIndex];
        }

        // AI Chat functionality
        function initializeAIChat() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendChatBtn');
            const chatMessages = document.getElementById('chatMessages');
            const suggestionChips = document.querySelectorAll('.suggestion-chip');

            if (!chatInput || !sendBtn || !chatMessages) return;

            // Handle suggestion chips
            suggestionChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    const question = chip.dataset.question;
                    chatInput.value = question;
                    sendMessage();
                });
            });

            // Handle send button
            sendBtn.addEventListener('click', sendMessage);

            // Handle Enter key
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            async function sendMessage() {
                const messageInput = document.getElementById('user-message');

                // Check if the input element exists
                if (!messageInput) {
                    console.error('‚ùå Message input element not found');
                    alert('Chat interface not properly loaded. Please refresh the page.');
                    return;
                }

                const message = messageInput.value.trim();

                if (!message) {
                    alert('Please enter a message');
                    return;
                }

                console.log('üì§ Sending message:', message);

                try {
                    // Add user message to chat
                    addMessageToChat('user', message);
                    messageInput.value = '';

                    // Show loading indicator
                    addMessageToChat('ai', 'Thinking...', true);

                    // Get current itinerary data from the page
                    const currentItinerary = {
                        title: document.querySelector('h1')?.textContent || 'Current Trip',
                        duration_days: 7, // You can extract this from the page data
                        region: 'Vietnam', // You can extract this from the page data
                        budget_level: 'medium', // You can extract this from the page data
                        description: 'Current itinerary description' // You can extract this from the page data
                    };

                    // Make the API call to the correct endpoint
                    const response = await fetch('/api/customize-trip', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_request: message,
                            current_itinerary: currentItinerary,
                            user_preferences: {},
                            customization_type: 'general'
                        })
                    });

                    console.log('üì• Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('‚úÖ AI Response:', result);

                    // Remove loading message
                    removeLastMessage();

                    if (result.success && result.response) {
                        // Add AI response to chat
                        const aiMessage = result.response.customization_suggestions || result.response;
                        addMessageToChat('ai', aiMessage);
                    } else {
                        addMessageToChat('ai', 'Sorry, I encountered an error. Please try again.');
                    }

                } catch (error) {
                    console.error('‚ùå Error getting AI response:', error);

                    // Remove loading message
                    removeLastMessage();

                    // Show error message
                    addMessageToChat('ai', `Sorry, I'm having trouble right now. Error: ${error.message}`);
                }
            }

            function addMessageToChat(sender, message, isLoading = false) {
                const chatContainer = document.getElementById('chat-messages');

                if (!chatContainer) {
                    console.error('‚ùå Chat container not found');
                    return;
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;

                if (isLoading) {
                    messageDiv.id = 'loading-message';
                }

                messageDiv.innerHTML = `
                <div class="message-content">
                  <strong>${sender === 'user' ? 'You' : 'AI Assistant'}:</strong>
                  <p>${message}</p>
                </div>
              `;

                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function removeLastMessage() {
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.remove();
                }
            }

            // Test function for debugging
            async function testAIConnection() {
                try {
                    console.log('üß™ Testing AI connection...');

                    // Test 1: Check AI status
                    const statusResponse = await fetch('/api/ai-status');
                    const statusData = await statusResponse.json();
                    console.log('üìä AI Status:', statusData);

                    if (!statusData.ready) {
                        alert('AI not ready. Check console for details.');
                        return;
                    }

                    // Test 2: Test customize-trip endpoint
                    const customizeResponse = await fetch('/api/customize-trip', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_request: 'Test message',
                            current_itinerary: {
                                title: 'Test Trip',
                                duration_days: 5,
                                region: 'Vietnam',
                                budget_level: 'medium',
                                description: 'Test description'
                            }
                        })
                    });

                    if (customizeResponse.ok) {
                        const customizeData = await customizeResponse.json();
                        console.log('üéØ Customize Test:', customizeData);
                        alert('AI is working! Check console for details.');
                    } else {
                        alert(`AI test failed: ${customizeResponse.status}`);
                    }

                } catch (error) {
                    console.error('‚ùå Test failed:', error);
                    alert('Test failed: ' + error.message);
                }
            }
        }
    </script>

    <!-- Auto-refresh script - COMPLETELY REWRITTEN -->
    <script src="/js/auto-refresh.js"></script>
    <script>
        let tripAutoRefresh = null;

        function startTripAutoRefresh(itineraryId) {
            if (tripAutoRefresh) {
                tripAutoRefresh.stop();
            }

            tripAutoRefresh = new AutoRefresh({
                interval: 30000, // 30 seconds for faster updates
                onUpdate: async (freshData, forceRefresh) => {
                    console.log('üîÑ Auto-refresh triggered for trip details...');

                    try {
                        // Always clear cache and fetch fresh data
                        localStorage.removeItem('selectedTripForDetailView');

                        // Fetch fresh itinerary data
                        const response = await fetch('/api/itineraries?refresh=true&t=' + Date.now());

                        if (response.ok) {
                            const data = await response.json();
                            console.log('üìã Fresh itinerary data received:', data);

                            if (data.itineraries && data.itineraries.length > 0) {
                                const foundTrip = data.itineraries.find(trip =>
                                    (trip['id:'] && trip['id:'] === itineraryId) ||
                                    (trip.id && trip.id === itineraryId)
                                );

                                if (foundTrip) {
                                    console.log('‚úÖ Found updated trip data');

                                    // Update global trip data
                                    currentTripData = foundTrip;
                                    localStorage.setItem('selectedTripForDetailView', JSON.stringify(foundTrip));

                                    // Re-populate the trip details
                                    populateTripDetails(foundTrip);

                                    // If itinerary section is open, refresh it too
                                    if (detailedItinerarySection && detailedItinerarySection.style.display === 'block') {
                                        await loadDailyItinerary(true);
                                    }

                                    console.log('‚úÖ Trip details updated successfully');
                                } else {
                                    console.log('‚ö†Ô∏è Trip not found in updated data');
                                }
                            }
                        } else {
                            throw new Error(`API request failed: ${response.status}`);
                        }

                    } catch (error) {
                        console.error('‚ùå Auto-refresh error:', error);
                    }
                },
                onError: (error) => {
                    console.error('‚ùå Auto-refresh error:', error);
                }
            });

            tripAutoRefresh.start();
            console.log('‚úÖ Auto-refresh started for trip details');
            return tripAutoRefresh;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const itineraryId = urlParams.get('id');

            if (itineraryId) {
                // Start auto-refresh after initial load
                setTimeout(() => {
                    window.tripAutoRefresh = startTripAutoRefresh(itineraryId);
                }, 2000);
            }
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (tripAutoRefresh) {
                tripAutoRefresh.stop();
            }
        });

        // Add hidden refresh functionality (can be triggered via console)
        window.forceRefreshTripData = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const itineraryId = urlParams.get('id');

            if (itineraryId) {
                console.log('üîÑ Force refreshing trip data...');
                localStorage.removeItem('selectedTripForDetailView');
                fetchFreshTripData(itineraryId, null);
            }
        };

        // Add keyboard shortcut for force refresh (Ctrl+R or Cmd+R)
        document.addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'r' && e.shiftKey) {
                e.preventDefault();
                window.forceRefreshTripData();
            }
        });
    </script>
</body>

</html>